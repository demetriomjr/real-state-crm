# 1. Entidades (MVP — Fase 1) — fonte única do modelo

Campos padrão de auditoria (todas as entidades P0):
- id (UUID), createdAt, updatedAt, createdBy, updatedBy, tenantId, deleteReason? (para arquivados)

---

## 1. Tenant e User (P0) — resumo
Objetivo: estabelecer o recorte mínimo de multi-tenancy e permissões.

Tenant (organização)
- id, nome, criadoEm, atualizadoEm.

User (por tenant)
- id, tenantId, email, senhaHash, nome, isMaster (boolean), criadoEm, atualizadoEm.

Regras
- Cada usuário pertence a exatamente um tenant (empresa).
- O primeiro usuário que cria o tenant é marcado como isMaster = true.
- Permissões: usuário master pode cadastrar/gerenciar usuários do tenant; demais usuários têm acesso a todas as funcionalidades de negócio, exceto gestão de usuários.

---

## 2. Pessoa (P0)
Objetivo: unificar “lead” e “cliente” em um único cadastro. O perfil “cliente” é derivado por colateral (ex.: criação do primeiro Pedido em simulação).

Estrutura (mínima):
- id, tenantId, nome, status ("Novo" | "Em contato" | "Agendado" | "Arquivado"),
  contato: { whatsapp?: string, email?: string },
  notas?, origem?,
    perfil (derivado: "Lead" | "Cliente"),
    perfilDerivadoEm?, perfilDerivadoPorAto? (ex.: "pedido.simulacao.criado"),
  criadoEm, atualizadoEm.

Regras
- Pelo menos um meio de contato (whatsapp ou email).
- Arquivável via soft delete; consultas padrão ocultam arquivados, salvo quando explicitamente incluídos.
- Perfil derivado: “Cliente” quando existir pelo menos um Pedido (Order) em Simulação associado à pessoa (ver [1.4.Colaterals.md](1.4.Colaterals.md)).

Índices sugeridos
- (tenantId, status), (tenantId, nome), (tenantId, contato.whatsapp).

---

## 3. Message (P1)
Objetivo: registrar mensagens enviadas e recebidas associadas a uma pessoa.

Estrutura (mínima)
- id, tenantId, personId, direction ("in" | "out"), providerMessageId, body, sentAt (ISO), metadata (json).

Regras
- direction obrigatório; associada a uma pessoa do mesmo tenant.
- providerMessageId para deduplicação com provedor (WhatsApp Cloud API).

---

## 4. Appointment (P1)
Objetivo: registrar visitas/atendimentos (agenda) relacionados à pessoa.

Estrutura (mínima)
- id, tenantId, personId, calendarEventId, startsAt, endsAt, location, notes,

Regras
- startsAt < endsAt; calendarEventId obrigatório quando integração ativa.
- Ao criar, registrar evento no Google Calendar e armazenar calendarEventId.

---

## 5. Order (Pedido) (P1)
Objetivo: unificar “Orçamento” (Budget) e “Negócio/Deal” em um único modelo.

Descrição
- Orçamento = Pedido em Simulação: uma proposta/estimativa ainda não aprovada, usada para cotar valores e escopo.
- Negócio (Deal) = Pedido Aprovado: aprovado pelo cliente e pelo setor/área competente da imobiliária; apto a seguir para execução/produção.

Estrutura (mínima)
- id, tenantId, personId, numero, itens[], valorTotal,
  tipo ("Simulação" | "Aprovado"),
  // campos opcionais por tipo
  statusOrcamento? ("Rascunho"|"Enviado"|"Aceito"|"Recusado"),
  faseAprovado? ("Qualificação"|"Proposta"|"Negociação"|"Ganho"|"Perdido"),
  criadoEm, atualizadoEm.

Regras
- tipo = "Simulação" representa o antigo Orçamento.
- tipo = "Aprovado" representa o antigo Negócio (Deal) aprovado por cliente e setor competente.
- O primeiro Pedido em Simulação criado para uma pessoa dispara a conversão de perfil para “Cliente” (ver Colaterais).

---

## 6. Relacionamentos (resumo)
- Pessoa 1—n Message
- Pessoa 1—n Appointment
- Pessoa 1—n Order (P1)

---

## 8. Colaterais Técnicos e de Dados (MVP)
- Isolamento por organização: toda entidade referencia tenantId; dados não se misturam entre organizações.
- Integrações por organização: mensageria e agenda configuradas e usadas por tenant; falhas ficam isoladas.
- Padrões de integridade: validações necessárias, atomicidade transacional onde fizer sentido.
- Política P0: não realizar exclusões em cadeia entre entidades.
- Preferência por arquivamento (soft delete) em vez de exclusão definitiva.
 - Permissões: usuário master (criador da empresa) pode gerenciar usuários do tenant; demais usuários não podem criar/editar usuários.

---

## 9. Invariantes de Modelo (P0)
- (P1) Uma pessoa não pode estar “Agendada” sem pelo menos um Appointment ativo.
- Não é possível alterar tenantId de uma entidade.
- Auditoria: toda ação relevante registra responsável e motivo.

---

## 9. Diagrama de estados das entidades (MVP)
Objetivo: padronizar o “estado” (status) de captação em Pessoa e suas transições válidas. O perfil “Cliente” é derivado por colateral (criação do primeiro Pedido em Simulação).

Pessoa (captação)
- Novo → Em contato
    - Gatilhos: 1ª mensagem enviada/recebida; atualização manual com nota.
- Em contato → Agendado
    - Gatilhos (P1): criação de Agendamento Ativo a partir da pessoa; no P0, alteração pode ser manual.
- Agendado → Em contato
    - Gatilhos (P1): cancelamento de Agendamento (Calendar OK); no P0, alteração pode ser manual.
- Em contato → Arquivado
    - Gatilhos: decisão manual (sem aderência/sem resposta), exige `deleteReason`.
- Qualquer estado → Arquivado
    - Gatilhos: arquivamento manual com motivo.

Perfil derivado (Lead/Cliente) — Colateral
- Regra: ao criar o primeiro Pedido (Simulação) para a pessoa ⇒ perfil = "Cliente"; registrar `perfilDerivadoEm` e `perfilDerivadoPorAto = "pedido.simulacao.criado"`.

---

## 10. Observações de Tenancy e Integridade
- Tenancy por organização: queries padrão com filtro por tenant, alterações exigem owner.
- Sem exclusões em cadeia no P0.
- Inconsistências entre entidades ⇒ validar vínculos antes de ações sensíveis; manter histórico e relatórios consistentes por organização.

---

## 11. Referências internas
- Parâmetros de contexto (leituras obrigatórias): [0.1.parameter-context.md](0.1.parameter-context.md)
- Sumário da documentação: [0.0.SUMMARY.md](0.0.SUMMARY.md)

---

[← Voltar ao Sumário](0.0.SUMMARY.md)