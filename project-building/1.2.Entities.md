# 1. Entidades (MVP — Fase 1) — fonte única do modelo

Campos padrão de auditoria (todas as entidades P0):
- id (UUID), createdAt, updatedAt, createdBy, updatedBy, tenantId, deleteReason? (para arquivados)

---

## 2. Pessoa (P0)
Objetivo: unificar “lead” e “cliente” em um único cadastro. O perfil “cliente” é derivado por colateral (ex.: criação do primeiro orçamento).

Estrutura (mínima):
- id, tenantId, nome, status ("Novo" | "Em contato" | "Agendado" | "Arquivado"),
  contato: { whatsapp?: string, email?: string },
  notas?, origem?,
  perfil (derivado: "Lead" | "Cliente"),
  perfilDerivadoEm?, perfilDerivadoPorAto? (ex.: "orcamento.criado"),
  criadoEm, atualizadoEm.

Regras
- Pelo menos um meio de contato (whatsapp ou email).
- Arquivável via soft delete; consultas padrão ocultam arquivados, salvo quando explicitamente incluídos.
- Perfil derivado: “Cliente” quando existir pelo menos um Orçamento (Budget) associado à pessoa (ver [1.4.Colaterals.md](1.4.Colaterals.md)).

Índices sugeridos
- (tenantId, status), (tenantId, nome), (tenantId, contato.whatsapp).

---

## 3. Message (P0)
Objetivo: registrar mensagens enviadas e recebidas associadas a uma pessoa.

Estrutura (mínima)
- id, tenantId, personId, direction ("in" | "out"), providerMessageId, body, sentAt (ISO), metadata (json).

Regras
- direction obrigatório; associada a uma pessoa do mesmo tenant.
- providerMessageId para deduplicação com provedor (WhatsApp Cloud API).

---

## 4. Appointment (P0)
Objetivo: registrar visitas/atendimentos (agenda) relacionados à pessoa.

Estrutura (mínima)
- id, tenantId, personId, calendarEventId, startsAt, endsAt, location, notes,

Regras
- startsAt < endsAt; calendarEventId obrigatório quando integração ativa.
- Ao criar, registrar evento no Google Calendar e armazenar calendarEventId.

---

## 5. Budget (Orçamento) (P1)
Ideia
- Proposta/estimativa de serviço ou produto gerada para uma pessoa. A criação do primeiro orçamento dispara a conversão de perfil (Pessoa: Lead → Cliente) por colateral.

Estrutura (mínima)
- id, tenantId, personId, numero, itens[], valorTotal, status ("Rascunho"|"Enviado"|"Aceito"|"Recusado"), criadoEm, atualizadoEm.

---

## 6. Deal (Negócio) (P1)
Ideia
- Oportunidade comercial com valor, fase e probabilidade.

Estrutura (mínima)
- id, tenantId, personId, titulo, fase (ex.: "Qualificação"|"Proposta"|"Negociação"|"Ganho"|"Perdido"), valorEstimado, probabilidade%, criadoEm, atualizadoEm.

---

## 7. Relacionamentos (resumo)
- Pessoa 1—n Message
- Pessoa 1—n Appointment
- Pessoa 1—n Budget (P1)
- Pessoa 1—n Deal (P1)

---

## 8. Colaterais Técnicos e de Dados (MVP)
- Isolamento por organização: toda entidade referencia tenantId; dados não se misturam entre organizações.
- Integrações por organização: mensageria e agenda configuradas e usadas por tenant; falhas ficam isoladas.
- Padrões de integridade: validações necessárias, atomicidade transacional onde fizer sentido.
- Política P0: não realizar exclusões em cadeia entre entidades.
- Preferência por arquivamento (soft delete) em vez de exclusão definitiva.

---

## 9. Invariantes de Modelo (P0)
- Uma pessoa não pode estar “Agendada” sem pelo menos um Appointment ativo.
- Não é possível alterar tenantId de uma entidade.
- Auditoria: toda ação relevante registra responsável e motivo.

---

## 10. Diagrama de estados das entidades (MVP)
Objetivo: padronizar o “estado” (status) de captação em Pessoa e suas transições válidas. O perfil “Cliente” é derivado por colateral (criação do primeiro Orçamento).

Pessoa (captação)
- Novo → Em contato
    - Gatilhos: 1ª mensagem enviada/recebida; atualização manual com nota.
- Em contato → Agendado
    - Gatilhos: criação de Agendamento Ativo a partir da pessoa.
- Agendado → Em contato
    - Gatilhos: cancelamento de Agendamento (Calendar OK).
- Em contato → Arquivado
    - Gatilhos: decisão manual (sem aderência/sem resposta), exige `deleteReason`.
- Qualquer estado → Arquivado
    - Gatilhos: arquivamento manual com motivo.

Perfil derivado (Lead/Cliente) — Colateral
- Regra: ao criar o primeiro Orçamento para a pessoa ⇒ perfil = "Cliente"; registrar `perfilDerivadoEm` e `perfilDerivadoPorAto = "orcamento.criado"`.

---

## 11. Observações de Tenancy e Integridade
- Tenancy por organização: queries padrão com filtro por tenant, alterações exigem owner.
- Sem exclusões em cadeia no P0.
- Inconsistências entre entidades ⇒ validar vínculos antes de ações sensíveis; manter histórico e relatórios consistentes por organização.

---

## 12. Referências internas
- Parâmetros de contexto (leituras obrigatórias): [0.1.parameter-context.md](0.1.parameter-context.md)
- Sumário da documentação: [0.0.SUMMARY.md](0.0.SUMMARY.md)

---

[← Voltar ao Sumário](0.0.SUMMARY.md)