### üß± Entidades (MVP ‚Äî Fase 1)

Escopo
- P0 (obrigat√≥rio nesta fase): Organiza√ß√£o (Tenant), Usu√°rio, Lead, Mensagem, Agendamento.
- P1 (posterior): Cliente, Neg√≥cio (Deal).

Campos padr√£o de auditoria (todas as entidades P0):
- tenantId, createdAt, updatedAt, createdBy, updatedBy.

#### Organiza√ß√£o (Tenant) ‚Äî P0
Campos
- id, nome.

Regras
- Um usu√°rio pertence a exatamente uma organiza√ß√£o ativa por sess√£o.

#### Usu√°rio ‚Äî P0
Campos
- id, tenantId, nome, email (√∫nico por tenant), hashSenha, roles (ex.: ["agent", "admin"]).

Regras
- Autentica√ß√£o por e-mail/senha; JWT por sess√£o curta.
- E-mail √∫nico por tenant.

√çndices
- √önico por tenant: (tenantId, email).

#### Lead ‚Äî P0
Campos
- id, tenantId, nome, contato: { whatsapp?: string, email?: string }, interesse (texto curto),
  status ("Novo" | "Em contato" | "Agendado" | "Arquivado"), notas (texto livre),
  deletedAt?, deletedBy?, deleteReason?

Regras
- Pelo menos um meio de contato (whatsapp ou email).
- Atualiza√ß√£o de status deve registrar updatedAt/updatedBy.
- Arquiv√°vel via soft delete; consultas padr√£o ocultam arquivados, salvo quando explicitamente inclu√≠dos.

√çndices sugeridos
- (tenantId, status), (tenantId, nome), (tenantId, contato.whatsapp).

#### Mensagem (Message) ‚Äî P0
Campos
- id, tenantId, leadId, direction ("in" | "out"), providerMessageId, body, sentAt (ISO), metadata (json).

Regras
- direction obrigat√≥rio; associada a um lead do mesmo tenant.
- providerMessageId para deduplica√ß√£o com provedor (WhatsApp Cloud API).

√çndices
- Deduplica√ß√£o por provedor: (tenantId, providerMessageId) √∫nico.
- Consulta por hist√≥rico do lead: (tenantId, leadId, sentAt DESC).

#### Agendamento (Appointment) ‚Äî P0
Campos
- id, tenantId, leadId, calendarEventId, startsAt, endsAt, location, notes,
  canceledAt?, canceledBy?, cancelReason?

Regras
- startsAt < endsAt; calendarEventId obrigat√≥rio quando integra√ß√£o ativa.
- Ao criar, registrar evento no Google Calendar e armazenar calendarEventId.
- Consultas padr√£o excluem cancelados (canceledAt definidos).

√çndices
- Consulta por lead e in√≠cio: (tenantId, leadId, startsAt).

#### Cliente ‚Äî P1 (posterior)
Ideia
- Representa um lead convertido com dados mais completos (documentos, prefer√™ncias persistentes).

Campos m√≠nimos (proposto)
- id, tenantId, leadIdOrigem?, nome, contatos[], enderecos?, observacoes.

#### Neg√≥cio (Deal) ‚Äî P1 (posterior)
Ideia
- Oportunidade comercial com valor, fase e probabilidade. Fora do escopo P0.

Campos m√≠nimos (proposto)
- id, tenantId, leadId|clienteId, titulo, valorEstimado, fase, probabilidade, dataFechamentoPrevista.

#### Relacionamentos (vis√£o geral)
- Organiza√ß√£o 1‚ÄîN Usu√°rio
- Organiza√ß√£o 1‚ÄîN Lead
- Lead 1‚ÄîN Mensagem
- Lead 1‚ÄîN Agendamento
- (Posterior) Lead 1‚Äî1 Cliente; Cliente 1‚ÄîN Neg√≥cio

#### Diagrama de estados das entidades (MVP)
Objetivo: padronizar o ‚Äúestado‚Äù (status) das principais entidades no MVP e suas transi√ß√µes v√°lidas. O estado √© afetado por a√ß√µes do consultor e por colaterais (ex.: cria√ß√£o/cancelamento de agendamento, primeira mensagem trocada etc.).

Notas gerais
- Terminologia: neste documento, ‚Äúestado‚Äù e ‚Äústatus‚Äù s√£o equivalentes; o campo persistido em Lead permanece `status` no P0.
- Auditoria: toda transi√ß√£o registra `updatedAt/updatedBy` e o evento correspondente no hist√≥rico do lead.
- Multi-tenant: toda transi√ß√£o valida `tenantId` em ambas as pontas antes de efetivar.

Lead (P0)
- Estados suportados: `"Novo" | "Em contato" | "Agendado" | "Arquivado"`.
- Transi√ß√µes v√°lidas (gatilhos ‚Üí efeito):
    - Novo ‚Üí Em contato
        - Gatilhos: primeira mensagem enviada OU recebida via WhatsApp; atualiza√ß√£o manual do consultor com nota.
    - Novo ‚Üí Agendado
        - Gatilhos: cria√ß√£o de Agendamento ativo a partir do lead (mesmo sem troca pr√©via de mensagens).
    - Em contato ‚Üí Agendado
        - Gatilhos: cria√ß√£o de Agendamento ativo (Calendar OK).
    - Em contato ‚Üí Arquivado
        - Gatilhos: decis√£o manual (sem ader√™ncia/sem resposta), exige `deleteReason`.
    - Agendado ‚Üí Em contato
        - Gatilhos: cancelamento do agendamento (mant√©m o relacionamento ativo); opcionalmente registrar motivo.
    - Agendado ‚Üí Arquivado
        - Gatilhos: decis√£o manual (lead despriorizado ap√≥s agendamento). Recomendado registrar motivo.
    - Arquivado ‚Üí Em contato
        - Gatilhos: restaura√ß√£o manual; normalmente acompanhada de nova tentativa de contato.
- Restri√ß√µes:
    - ‚ÄúArquivado‚Äù n√£o pode ir diretamente para ‚ÄúAgendado‚Äù ‚Äî restaurar para ‚ÄúEm contato‚Äù primeiro.
    - Excluir definitivamente est√° fora do P0; preferir arquivar.

Agendamento (Appointment) (P0)
- Estados: `"Ativo" | "Cancelado"`.
- Deriva√ß√£o: se `canceledAt` definido ‚áí `Cancelado`; caso contr√°rio ‚áí `Ativo`.
- Regras de efeito no Lead:
    - Criar agendamento Ativo ‚áí for√ßa Lead a `Agendado`.
    - Cancelar agendamento ‚áí Lead volta a `Em contato` (se estava `Agendado`).

Mensagem (Message) (P0)
- Sem m√°quina de estados pr√≥pria no P0; mensagens s√£o imut√°veis e comp√µem o hist√≥rico.
- Futuro (P1+): opcional `deliveryStatus` de provedores (enviado/entregue/lido).

Invariantes e valida√ß√µes
- Transi√ß√µes inv√°lidas devem ser bloqueadas com feedback claro ao usu√°rio.
- Todo evento relevante (mensagem, cria√ß√£o/cancelamento de agendamento, arquivamento/restaura√ß√£o) aparece no hist√≥rico do lead.
- Nenhuma transi√ß√£o apaga hist√≥rico; arquivamento n√£o remove mensagens nem agendamentos j√° registrados.

#### Colaterais T√©cnicos e de Dados (MVP)
Tenancy ‚Äî efeitos nos dados
- Isolamento por organiza√ß√£o: toda entidade referencia tenantId; dados n√£o se misturam entre organiza√ß√µes.
- Integra√ß√µes por organiza√ß√£o: mensageria e agenda configuradas e usadas por tenant; eventuais falhas ficam isoladas.
- Relat√≥rios e privacidade: indicadores consolidados por organiza√ß√£o; acesso restrito aos perfis daquela organiza√ß√£o.

Integridade e cascatas
- Pol√≠tica P0: n√£o realizar exclus√µes em cadeia entre entidades.
- Prefer√™ncia por arquivamento (soft delete) em vez de exclus√£o definitiva.
- Mudan√ßa de status do lead n√£o apaga hist√≥rico (mensagens, agendamentos permanecem). 
- Organiza√ß√£o desativada: acesso bloqueado; dados preservados para decis√£o posterior (exporta√ß√£o/reten√ß√£o).
- Restri√ß√µes de integridade: chaves estrangeiras com ON DELETE RESTRICT e valida√ß√£o de tenantId em ambos os lados do relacionamento.

Arquivamento (Soft Delete)
- Conceito: em vez de apagar, marcar como "Arquivado" (campos deletedAt/deletedBy/deleteReason quando aplic√°vel).
- Consulta: listas padr√£o ocultam registros arquivados; acesso sob perfis autorizados pode incluir arquivados quando necess√°rio.
- Ciclo de vida: Ativo ‚Üí Arquivado ‚Üí (opcional) Restaurado ‚Üí Exclus√£o permanente (excepcional, sem v√≠nculos pendentes e sob controle).
- Auditoria: toda a√ß√£o relevante registra respons√°vel e motivo quando aplic√°vel.

Cancelamento de Agendamentos
- Campos de cancelamento (canceledAt/canceledBy/cancelReason) para preservar hist√≥rico do compromisso.
- Cancelar n√£o remove o registro; permanece vis√≠vel no contexto do lead.

Crit√©rios (dados)
- Toda opera√ß√£o consulta/filtra por tenantId por padr√£o.
- Sem exclus√µes em cadeia entre entidades no P0.
- Arquivar lead mant√©m hist√≥rico (mensagens, agendamentos) intacto.
- Inclus√£o/exclus√£o de arquivados/cancelados nas consultas √© expl√≠cita; por padr√£o, consultas excluem deletedAt/canceledAt.
- Lead sempre com status v√°lido; mudan√ßas registram updatedAt/updatedBy.
- Mensagens armazenam direction e sentAt; hist√≥rico vis√≠vel por lead.
- Agendamento cria/atualiza calendarEventId quando integra√ß√£o estiver ativa.

Riscos e mitiga√ß√µes (dados)
- Perda acidental por exclus√£o permanente ‚Üí restringir perfis, dupla confirma√ß√£o e preferir arquivar.
- Inconsist√™ncias entre entidades ‚Üí validar v√≠nculos antes de a√ß√µes sens√≠veis; manter hist√≥rico e relat√≥rios consistentes por organiza√ß√£o.

Refer√™ncias internas
- Par√¢metros de contexto (leituras obrigat√≥rias): `parameter-context.md`
- Sum√°rio da documenta√ß√£o: `SUM√ÅRIO.md`

---

[‚Üê Voltar ao Sum√°rio](0.0.SUMMARY.md)